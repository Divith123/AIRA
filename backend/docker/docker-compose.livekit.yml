# =============================================================================
# LIVEKIT COMPLETE SELF-HOSTED STACK
# All-in-one Docker Compose for development & testing
# =============================================================================
#
# This compose file includes:
# - LiveKit Server (Core WebRTC SFU)
# - Redis (Message broker)
# - Ingress (RTMP/WHIP ingest)
# - Egress (Recording/Streaming)
# - SIP (Telephony - optional)
# - AI Services (STT, TTS, LLM)
#
# Usage:
#   # Start core services (recommended for development)
#   docker compose -f docker-compose.livekit.yml up -d
#
#   # Start with AI services (requires GPU)
#   docker compose -f docker-compose.livekit.yml --profile ai-gpu up -d
#
#   # Start with AI services (CPU only)
#   docker compose -f docker-compose.livekit.yml --profile ai-cpu up -d
#
#   # Start with SIP telephony
#   docker compose -f docker-compose.livekit.yml --profile sip up -d
#
# =============================================================================

services:
  # ===========================================================================
  # CORE: Redis
  # Message broker and state store for LiveKit services
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: livekit-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --save 60 1
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - livekit-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ===========================================================================
  # CORE: LiveKit Server
  # The WebRTC SFU (Selective Forwarding Unit)
  # ===========================================================================
  livekit:
    image: livekit/livekit-server:v1.8
    container_name: livekit-server
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "7880:7880"   # HTTP API
      - "7881:7881"   # RTC over TCP
      - "7882:7882/udp" # RTC over UDP
      - "50100-50200:50100-50200/udp" # WebRTC ports
    environment:
      - "LIVEKIT_KEYS=devkey: mCafIFJr80hhRBYVBKCUqgOLEiIpRFLj5RAfEaNjF8p"
    command: >
      --config /etc/livekit.yaml
      --bind 0.0.0.0
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml:ro
    networks:
      - livekit-net
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:7880/"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # INGRESS: RTMP/WHIP Ingest
  # Accept external media streams
  # ===========================================================================
  ingress:
    image: livekit/ingress:latest
    container_name: livekit-ingress
    restart: unless-stopped
    depends_on:
      livekit:
        condition: service_healthy
    ports:
      - "1935:1935"   # RTMP
      - "8090:8080"   # WHIP (HTTP)
    environment:
      - INGRESS_CONFIG_FILE=/etc/ingress.yaml
    volumes:
      - ./ingress.yaml:/etc/ingress.yaml:ro
    networks:
      - livekit-net

  # ===========================================================================
  # EGRESS: Recording & Streaming
  # Record rooms, stream to RTMP destinations
  # ===========================================================================
  egress:
    image: livekit/egress:latest
    container_name: livekit-egress
    restart: unless-stopped
    depends_on:
      livekit:
        condition: service_healthy
    environment:
      - EGRESS_CONFIG_FILE=/etc/egress.yaml
    volumes:
      - ./egress.yaml:/etc/egress.yaml:ro
      - egress-output:/out
    networks:
      - livekit-net
    cap_add:
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined

  # ===========================================================================
  # SIP: Telephony Bridge (Optional)
  # Connect to PSTN/phone networks
  # ===========================================================================
  sip:
    image: livekit/sip:v1.4
    container_name: livekit-sip
    restart: unless-stopped
    profiles: ["sip", "full"]
    depends_on:
      livekit:
        condition: service_healthy
    ports:
      - "5060:5060/udp"   # SIP UDP
      - "5060:5060/tcp"   # SIP TCP
    environment:
      - SIP_CONFIG_FILE=/etc/sip.yaml
    volumes:
      - ./sip.yaml:/etc/sip.yaml:ro
    networks:
      - livekit-net

  # ===========================================================================
  # AI: faster-whisper STT (GPU)
  # ===========================================================================
  whisper-gpu:
    image: fedirz/faster-whisper-server:latest-cuda
    container_name: whisper-stt-gpu
    profiles: ["ai-gpu", "full"]
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - WHISPER__MODEL=Systran/faster-whisper-large-v3-turbo
      - WHISPER__DEVICE=cuda
      - WHISPER__COMPUTE_TYPE=float16
    volumes:
      - whisper-models:/root/.cache/huggingface
    networks:
      - livekit-net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # ===========================================================================
  # AI: faster-whisper STT (CPU)
  # ===========================================================================
  whisper-cpu:
    image: fedirz/faster-whisper-server:latest-cpu
    container_name: whisper-stt-cpu
    profiles: ["ai-cpu"]
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - WHISPER__MODEL=Systran/faster-whisper-small
      - WHISPER__DEVICE=cpu
      - WHISPER__COMPUTE_TYPE=int8
    volumes:
      - whisper-models:/root/.cache/huggingface
    networks:
      - livekit-net

  # ===========================================================================
  # AI: Kokoro TTS (GPU)
  # ===========================================================================
  kokoro-gpu:
    image: ghcr.io/remsky/kokoro-fastapi-gpu:latest
    container_name: kokoro-tts-gpu
    profiles: ["ai-gpu", "full"]
    restart: unless-stopped
    ports:
      - "8880:8880"
    volumes:
      - kokoro-voices:/app/voices
    networks:
      - livekit-net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # ===========================================================================
  # AI: Kokoro TTS (CPU)
  # ===========================================================================
  kokoro-cpu:
    image: ghcr.io/remsky/kokoro-fastapi-cpu:latest
    container_name: kokoro-tts-cpu
    profiles: ["ai-cpu"]
    restart: unless-stopped
    ports:
      - "8880:8880"
    volumes:
      - kokoro-voices:/app/voices
    networks:
      - livekit-net

  # ===========================================================================
  # AI: Ollama LLM
  # ===========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: ollama-llm
    profiles: ["ai-gpu", "ai-cpu", "full"]
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    networks:
      - livekit-net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  redis-data:
  egress-output:
  whisper-models:
  kokoro-voices:
  ollama-models:

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  livekit-net:
    driver: bridge
